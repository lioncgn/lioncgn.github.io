<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/cloudauth.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/cloudauth-small.png">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-loading-bar.min.css">
  <script src="/lib/pace/pace.min.js"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://yoursite.com').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="Flask session原理">
<meta property="og:type" content="article">
<meta property="og:title" content="Flask session原理">
<meta property="og:url" content="http://yoursite.com/2020/07/20/Flask-session%E5%8E%9F%E7%90%86/index.html">
<meta property="og:site_name" content="你的眼神">
<meta property="og:description" content="Flask session原理">
<meta property="article:published_time" content="2020-07-20T01:10:38.000Z">
<meta property="article:modified_time" content="2020-07-20T04:10:03.963Z">
<meta property="article:author" content="cgn">
<meta property="article:tag" content="session">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/2020/07/20/Flask-session%E5%8E%9F%E7%90%86/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>Flask session原理 | 你的眼神</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">你的眼神</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">一念放恣，则万邪乘衅</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">21</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">6</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">40</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/lioncgn" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/20/Flask-session%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/sister.jpeg">
      <meta itemprop="name" content="cgn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="你的眼神">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Flask session原理
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-07-20 09:10:38 / 修改时间：12:10:03" itemprop="dateCreated datePublished" datetime="2020-07-20T09:10:38+08:00">2020-07-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/flask/" itemprop="url" rel="index">
                    <span itemprop="name">flask</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Flask-session原理"><a href="#Flask-session原理" class="headerlink" title=" Flask session原理 "></a><center> Flask session原理 </center></h1><a id="more"></a>
<h2 id="1-当请求上下文被push-之后，接下来就开始操作session"><a href="#1-当请求上下文被push-之后，接下来就开始操作session" class="headerlink" title="1. 当请求上下文被push 之后，接下来就开始操作session"></a>1. 当请求上下文被<code>push</code> 之后，接下来就开始操作<code>session</code></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> self.session <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            session_interface = self.app.session_interface</span><br><span class="line">            self.session = session_interface.open_session(self.app, self.request)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> self.session <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="comment"># 用来处理 app.secret_key 未设置的情况，这时候初始化一个NullSession对象</span></span><br><span class="line">                self.session = session_interface.make_null_session(self.app)</span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SecureCookieSessionInterface</span><span class="params">(SessionInterface)</span>:</span>              </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open_session</span><span class="params">(self, app, request)</span>:</span></span><br><span class="line">        s = self.get_signing_serializer(app)</span><br><span class="line">        <span class="keyword">if</span> s <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># 如果没有设置app.secret_key, 将返回None</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="comment"># 从cookie中取出键名为session的值</span></span><br><span class="line">        val = request.cookies.get(app.session_cookie_name)</span><br><span class="line">        <span class="comment"># 值不存在，返回一个 SecureCookieSession对象</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> val:</span><br><span class="line">            <span class="keyword">return</span> self.session_class()</span><br><span class="line">        max_age = total_seconds(app.permanent_session_lifetime)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 值存在，通过loads方法将随机字符串 解密成一个python对象，也就是一个字典</span></span><br><span class="line">            data = s.loads(val, max_age=max_age)</span><br><span class="line">            <span class="keyword">return</span> self.session_class(data)</span><br><span class="line">        <span class="keyword">except</span> BadSignature:</span><br><span class="line">            <span class="keyword">return</span> self.session_class()</span><br></pre></td></tr></table></figure>

<h2 id="2-在视图函数中处理session"><a href="#2-在视图函数中处理session" class="headerlink" title="2. 在视图函数中处理session"></a>2. 在视图函数中处理<code>session</code></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从flask 导入全局代理对象</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> session, Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    print(session)  <span class="comment"># 最终将调用 CallbackDict类的__repr__()</span></span><br><span class="line">    session[<span class="string">'test'</span>] = <span class="string">'hello'</span> <span class="comment"># 最终调用的是 UpdateDictMixin 类中的__setitem__()</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"hello test sessionk"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SecureCookieSession</span><span class="params">(CallbackDict, SessionMixin)</span>:</span></span><br><span class="line">    </span><br><span class="line">    modified = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    accessed = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, initial=None)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">on_update</span><span class="params">(self)</span>:</span></span><br><span class="line">            self.modified = <span class="literal">True</span></span><br><span class="line">            self.accessed = <span class="literal">True</span></span><br><span class="line">        <span class="comment"># print(self.__class__)</span></span><br><span class="line">        <span class="comment"># print(self.__class__.mro())</span></span><br><span class="line">        <span class="comment"># 对于多继承来说，super() 返回的是要寻找的哪个父类</span></span><br><span class="line">        <span class="string">'''[&lt;class 'flask.sessions.SecureCookieSession'&gt;, &lt;class 'werkzeug.datastructures.CallbackDict'&gt;, &lt;class 'werkzeug.datastructures.UpdateDictMixin'&gt;, &lt;class 'dict'&gt;, &lt;class 'flask.sessions.SessionMixin'&gt;, &lt;class 'collections.abc.MutableMapping'&gt;, &lt;class 'collections.abc.Mapping'&gt;, &lt;class 'collections.abc.Collection'&gt;, &lt;class 'collections.abc.Sized'&gt;, &lt;class 'collections.abc.Iterable'&gt;, &lt;class 'collections.abc.Container'&gt;, &lt;class 'object'&gt;]</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line"></span><br><span class="line">        super(SecureCookieSession, self).__init__(initial, on_update)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        self.accessed = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> super(SecureCookieSession, self).__getitem__(key)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, key, default=None)</span>:</span></span><br><span class="line">        self.accessed = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> super(SecureCookieSession, self).get(key, default)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setdefault</span><span class="params">(self, key, default=None)</span>:</span></span><br><span class="line">        self.accessed = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> super(SecureCookieSession, self).setdefault(key, default)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CallbackDict</span><span class="params">(UpdateDictMixin, dict)</span>:</span></span><br><span class="line">    <span class="string">"""A dict that calls a function passed every time something is changed.</span></span><br><span class="line"><span class="string">    The function is passed the dict instance.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, initial=None, on_update=None)</span>:</span></span><br><span class="line">        dict.__init__(self, initial <span class="keyword">or</span> ())</span><br><span class="line">        self.on_update = on_update</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># print('print session')</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;%s %s&gt;"</span> % (self.__class__.__name__, dict.__repr__(self))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UpdateDictMixin</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Makes dicts call `self.on_update` on modifications.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. versionadded:: 0.5</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :private:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    on_update = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">calls_update</span><span class="params">(name)</span>:</span>  <span class="comment"># noqa: B902</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">oncall</span><span class="params">(self, *args, **kw)</span>:</span></span><br><span class="line">            rv = getattr(super(UpdateDictMixin, self), name)(*args, **kw)</span><br><span class="line">            <span class="keyword">if</span> self.on_update <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                self.on_update(self)</span><br><span class="line">            <span class="keyword">return</span> rv</span><br><span class="line"></span><br><span class="line">        oncall.__name__ = name</span><br><span class="line">        <span class="keyword">return</span> oncall</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setdefault</span><span class="params">(self, key, default=None)</span>:</span></span><br><span class="line">        modified = key <span class="keyword">not</span> <span class="keyword">in</span> self</span><br><span class="line">        rv = super(UpdateDictMixin, self).setdefault(key, default)</span><br><span class="line">        <span class="keyword">if</span> modified <span class="keyword">and</span> self.on_update <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.on_update(self)</span><br><span class="line">        <span class="keyword">return</span> rv</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pop</span><span class="params">(self, key, default=_missing)</span>:</span></span><br><span class="line">        modified = key <span class="keyword">in</span> self</span><br><span class="line">        <span class="keyword">if</span> default <span class="keyword">is</span> _missing:</span><br><span class="line">            rv = super(UpdateDictMixin, self).pop(key)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            rv = super(UpdateDictMixin, self).pop(key, default)</span><br><span class="line">        <span class="keyword">if</span> modified <span class="keyword">and</span> self.on_update <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.on_update(self)</span><br><span class="line">        <span class="keyword">return</span> rv</span><br><span class="line"></span><br><span class="line">    __setitem__ = calls_update(<span class="string">"__setitem__"</span>)</span><br><span class="line">    __delitem__ = calls_update(<span class="string">"__delitem__"</span>)</span><br><span class="line">    clear = calls_update(<span class="string">"clear"</span>)</span><br><span class="line">    popitem = calls_update(<span class="string">"popitem"</span>)</span><br><span class="line">    update = calls_update(<span class="string">"update"</span>)</span><br><span class="line">    <span class="keyword">del</span> calls_update</span><br></pre></td></tr></table></figure>

<h2 id="3-在请求处理完成，返回响应时候，对于session处理"><a href="#3-在请求处理完成，返回响应时候，对于session处理" class="headerlink" title="3. 在请求处理完成，返回响应时候，对于session处理"></a>3. 在请求处理完成，返回响应时候，对于session处理</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, response)</span>:</span></span><br><span class="line">      <span class="string">"""Can be overridden in order to modify the response object</span></span><br><span class="line"><span class="string">      before it's sent to the WSGI server.  By default this will</span></span><br><span class="line"><span class="string">      call all the :meth:`after_request` decorated functions.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      .. versionchanged:: 0.5</span></span><br><span class="line"><span class="string">         As of Flask 0.5 the functions registered for after request</span></span><br><span class="line"><span class="string">         execution are called in reverse order of registration.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      :param response: a :attr:`response_class` object.</span></span><br><span class="line"><span class="string">      :return: a new response object or the same, has to be an</span></span><br><span class="line"><span class="string">               instance of :attr:`response_class`.</span></span><br><span class="line"><span class="string">      """</span></span><br><span class="line">      ctx = _request_ctx_stack.top</span><br><span class="line">      bp = ctx.request.blueprint</span><br><span class="line">      funcs = ctx._after_request_functions</span><br><span class="line">      <span class="keyword">if</span> bp <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> bp <span class="keyword">in</span> self.after_request_funcs:</span><br><span class="line">          funcs = chain(funcs, reversed(self.after_request_funcs[bp]))</span><br><span class="line">      <span class="keyword">if</span> <span class="literal">None</span> <span class="keyword">in</span> self.after_request_funcs:</span><br><span class="line">          funcs = chain(funcs, reversed(self.after_request_funcs[<span class="literal">None</span>]))</span><br><span class="line">      <span class="keyword">for</span> handler <span class="keyword">in</span> funcs:</span><br><span class="line">          response = handler(response)</span><br><span class="line">      <span class="comment"># 判断是否是 NullSession对象(也就是是否设置secret_key)</span></span><br><span class="line">      <span class="comment"># 如果没有设置secret_key 直接跳过</span></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> self.session_interface.is_null_session(ctx.session):</span><br><span class="line">          self.session_interface.save_session(self, ctx.session, response)</span><br><span class="line">      <span class="keyword">return</span> response</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">save_session</span><span class="params">(self, app, session, response)</span>:</span></span><br><span class="line">      domain = self.get_cookie_domain(app)</span><br><span class="line">      path = self.get_cookie_path(app)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># If the session is modified to be empty, remove the cookie.</span></span><br><span class="line">      <span class="comment"># If the session is empty, return without setting the cookie.</span></span><br><span class="line">      <span class="comment"># 删除 session时候</span></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> session:</span><br><span class="line">          <span class="keyword">if</span> session.modified:</span><br><span class="line">              response.delete_cookie(</span><br><span class="line">                  app.session_cookie_name, domain=domain, path=path</span><br><span class="line">              )</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># Add a "Vary: Cookie" header if the session was accessed at all.</span></span><br><span class="line">      <span class="keyword">if</span> session.accessed:</span><br><span class="line">          response.vary.add(<span class="string">"Cookie"</span>)</span><br><span class="line"><span class="comment"># 这个条件表示 当session没有修改过，一旦设置session.permanent为True,那么也要重新set_cookie</span></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> self.should_set_cookie(app, session):</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      httponly = self.get_cookie_httponly(app)</span><br><span class="line">      secure = self.get_cookie_secure(app)</span><br><span class="line">      samesite = self.get_cookie_samesite(app)</span><br><span class="line">      expires = self.get_expiration_time(app, session)</span><br><span class="line">      print(<span class="string">'expires is '</span>, expires)</span><br><span class="line">      val = self.get_signing_serializer(app).dumps(dict(session))</span><br><span class="line">      response.set_cookie(</span><br><span class="line">          app.session_cookie_name,</span><br><span class="line">          val,</span><br><span class="line">          expires=expires,</span><br><span class="line">          httponly=httponly,</span><br><span class="line">          domain=domain,</span><br><span class="line">          path=path,</span><br><span class="line">          secure=secure,</span><br><span class="line">          samesite=samesite,</span><br><span class="line">      )</span><br></pre></td></tr></table></figure>

<p>至此，<code>flask</code>中的<code>session</code> 完成。</p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>flask框架内置的<code>session</code>  通过<code>cookie</code> 进行设置的。</p>
<ul>
<li><p><code>session</code> 的过期时间，默认情况下，当浏览器关闭时，<code>session</code> 过期；但是当设置了<code>session.permanent = True</code>后，默认的过期时间根据<code>PERMANENT_SESSION_LEFETIME</code>  来计算，默认情况下是 <code>timedelta(days=31)</code> ; 这里再来提一下，对于chrome浏览器，有时候浏览器关闭后，<code>session</code> 并没有被清除的解释 <a href="http://blog.petersondave.com/cookies/Session-Cookies-in-Chrome-Firefox-and-Sitecore/" target="_blank" rel="noopener">Session Cookies in Chrome, Firefox, and Sitecore</a> ;中间有关于chrome浏览器的介绍:</p>
<ul>
<li><p>Since version 19, Chrome has altered how it runs in the background which has an immediate impact on how you expect Chrome to handle session cookies when you close your browser. Under <em>advanced settings &gt; System</em>, the option “Continue running background apps when Google Chrome is closed” is checked by default. In other words, if you close your browser, it will continue to run in the background (to support Chrome applications and extensions). Allowing Google Chrome to run in the background keeps the Chrome application session alive and prevents session cookies from being cleared.</p>
</li>
<li><p>The issue has been entered and marked as “won’t fix”, recognized as <a href="https://code.google.com/p/chromium/issues/detail?id=128513" target="_blank" rel="noopener">expected behavior by the development team</a>.</p>
</li>
</ul>
</li>
<li><p>flask 这种将<code>session</code> 存储在客户端的默认方式，并不安全，即使不知道密钥的情况下也可以轻易的解析出数据来，因此，不能用来存储敏感数据，或者存储到其他地方</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> base64_decode</span><br><span class="line">s = <span class="string">'eyJ0ZXN0IjoiaGVsbG8ifQ.XxUYlQ.2J3BtV8aACUDCaddD-ZxFlIEtRI'</span></span><br><span class="line">data, timestamp, secret = s.split(<span class="string">'.'</span>)</span><br><span class="line">base64_decode(data)</span><br><span class="line"><span class="comment"># 就可以解析出 '&#123;"test":"hello"&#125;'</span></span><br></pre></td></tr></table></figure>



<h2 id="5-使用第三方插件，将session-存放到redis-中如何操作"><a href="#5-使用第三方插件，将session-存放到redis-中如何操作" class="headerlink" title="5. 使用第三方插件，将session 存放到redis 中如何操作"></a>5. 使用第三方插件，将<code>session</code> 存放到<code>redis</code> 中如何操作</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_session <span class="keyword">import</span> Session</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">'test'</span></span><br><span class="line">app.config[<span class="string">'SESSION_TYPE'</span>] = <span class="string">'redis'</span></span><br><span class="line">app.config[<span class="string">'SESSION_REDIS'</span>] = Redis(password=<span class="string">'studyredis'</span>)</span><br><span class="line"></span><br><span class="line">sess = Session(app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    print(session)</span><br><span class="line">    session[<span class="string">'test'</span>] = <span class="string">'hello'</span> <span class="comment">#此时就能在redis数据库中找到session: 开头的key；</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Hello world"</span></span><br></pre></td></tr></table></figure>


    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/session/" rel="tag"># session</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/02/29/flask-restful%E6%89%A9%E5%B1%95%E4%BD%BF%E7%94%A8/" rel="prev" title="flask-restful扩展使用">
      <i class="fa fa-chevron-left"></i> flask-restful扩展使用
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/07/20/Flask%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86/" rel="next" title="Flask上下文管理">
      Flask上下文管理 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Flask-session原理"><span class="nav-number">1.</span> <span class="nav-text"> Flask session原理 </span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-当请求上下文被push-之后，接下来就开始操作session"><span class="nav-number">1.1.</span> <span class="nav-text">1. 当请求上下文被push 之后，接下来就开始操作session</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-在视图函数中处理session"><span class="nav-number">1.2.</span> <span class="nav-text">2. 在视图函数中处理session</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-在请求处理完成，返回响应时候，对于session处理"><span class="nav-number">1.3.</span> <span class="nav-text">3. 在请求处理完成，返回响应时候，对于session处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-总结"><span class="nav-number">1.4.</span> <span class="nav-text">4. 总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-使用第三方插件，将session-存放到redis-中如何操作"><span class="nav-number">1.5.</span> <span class="nav-text">5. 使用第三方插件，将session 存放到redis 中如何操作</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="cgn"
      src="/images/sister.jpeg">
  <p class="site-author-name" itemprop="name">cgn</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">40</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/lioncgn" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;lioncgn" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:cgnstudyflask@gmail.com" title="E-Mail → mailto:cgnstudyflask@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cgn</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.0
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/hong.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  <script src="/js/src/hong.js"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"log":false,"model":{"jsonPath":"/live2dw/assets/Epsilon2.1.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true}});</script></body>
</html>
